{% extends "base.html" %}

{% block content %}
<div class="button-group">
    <a href="/" class="btn btn-secondary">← Volver al Dashboard</a>
</div>

<div class="info-header">
    <div class="info-item">
        <span class="info-label">Minera:</span>
        <span class="info-value">{{ minera if minera else 'No seleccionada' }}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Transportista:</span>
        <span class="info-value">{{ transportista if transportista else 'No seleccionado' }}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Fecha:</span>
        <span class="info-value">{{ fecha if fecha else 'No seleccionada' }}</span>
    </div>
</div>

<div class="filters">
    <div class="filter-group">
        <label class="filter-label">Minera</label>
        <select id="mineraSelect" onchange="updateFilters()">
            <option value="">Seleccione una minera</option>
            {% for m in mineras %}
            <option value="{{ m }}" {% if minera and m == minera %}selected{% endif %}>
                {{ m }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Transportista</label>
        <select id="transportistaSelect" onchange="updateFilters()">
            <option value="">Seleccione un transportista</option>
            {% for t in transportistas %}
            <option value="{{ t }}" {% if transportista and t == transportista %}selected{% endif %}>
                {{ t }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Fecha</label>
        <input type="date" id="fechaInput" value="{{ fecha if fecha else '' }}" onchange="updateFilters()">
    </div>
</div>

{% if registros %}
<div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 25px;">
    <h2 style="margin-bottom: 20px; color: #333;">Registros de Viajes ({{ registros|length }} viajes)</h2>
    
    <table class="detail-table">
        <thead>
            <tr>
                <th>Pedido</th>
                <th>Camión</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Transportista</th>
                <th>Cliente</th>
                <th>Entregado</th>
            </tr>
        </thead>
        <tbody>
            {% for registro in registros %}
            <tr>
                <td><strong>{{ registro.get('vbeln', 'N/A') }}</strong></td>
                <td><strong style="color: #3498db;">{{ registro.get('vehiclereal', 'Sin información') }}</strong></td>
                <td>{{ registro.get('vdatu', 'N/A') }}</td>
                <td>{{ registro.get('descrstatu', 'N/A') }}</td>
                <td>{{ registro.get('Transportista', 'N/A') }}</td>
                <td>{{ registro.get('vtext', 'N/A') }}</td>
                <td>
                    {% if registro.get('Entregado totalmente', 0) == 1 %}
                    <span class="check-icon">✓</span>
                    {% else %}
                    <span class="cross-icon">✗</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div style="margin-top: 20px; padding: 15px; background: #f8f8f8; border-radius: 8px;">
    <h3 style="margin-bottom: 10px; font-size: 16px;">Resumen</h3>
    <div style="display: flex; gap: 30px; flex-wrap: wrap;">
        <div>
            <strong>Total de viajes:</strong> {{ registros|length }}
        </div>
        <div>
            <strong>Viajes entregados:</strong> 
            {{ registros|selectattr('Entregado totalmente', 'equalto', 1)|list|length }}
        </div>
        <div>
            <strong>Viajes pendientes:</strong> 
            {{ registros|selectattr('Entregado totalmente', 'equalto', 0)|list|length }}
        </div>
        <div>
            <strong>% Entregas completadas:</strong> 
            {% set entregados = registros|selectattr('Entregado totalmente', 'equalto', 1)|list|length %}
            {% set porcentaje = (entregados / registros|length * 100)|round|int if registros|length > 0 else 0 %}
            {% if porcentaje >= 85 %}
            <span style="color: #28a745; font-weight: bold;">{{ porcentaje }}%</span>
            {% else %}
            <span style="color: #dc3545; font-weight: bold;">{{ porcentaje }}%</span>
            {% endif %}
        </div>
    </div>
</div>

{% else %}
<div style="text-align: center; padding: 60px; background: #f8f8f8; border-radius: 8px;">
    <p style="font-size: 18px; color: #666;">
        No hay registros disponibles para la selección actual.
        <br><br>
        Por favor, seleccione Minera, Transportista y Fecha para ver los datos.
    </p>
</div>
{% endif %}

<div class="button-group" style="margin-top: 30px;">
    <a href="/admin/mineras" class="btn btn-secondary">Gestionar Mineras</a>
    <button class="btn btn-success" onclick="alert('Funcionalidad de carga de datos próximamente')">Cargar Datos (CSV/Excel)</button>
    <button class="btn btn-primary" onclick="alert('Funcionalidad de agregar viaje próximamente')">Agregar Viaje Manual</button>
</div>

{% endblock %}

{% block extra_js %}
<script>
function updateFilters() {
    const minera = document.getElementById('mineraSelect').value;
    const transportista = document.getElementById('transportistaSelect').value;
    const fecha = document.getElementById('fechaInput').value;
    
    if (minera && transportista && fecha) {
        window.location.href = `/detalle?minera=${encodeURIComponent(minera)}&transportista=${encodeURIComponent(transportista)}&fecha=${fecha}`;
    }
}
</script>
{% endblock %}
