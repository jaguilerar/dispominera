{% extends "base.html" %}

{% block content %}
<div class="button-group">
    <a href="/" class="btn btn-secondary">‚Üê Volver al Dashboard</a>
</div>

<div class="info-header">
    <div class="info-item">
        <span class="info-label">Minera:</span>
        <span class="info-value">{{ minera if minera else 'No seleccionada' }}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Transportista:</span>
        <span class="info-value">{{ transportista if transportista else 'No seleccionado' }}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Fecha:</span>
        <span class="info-value">{{ fecha if fecha else 'No seleccionada' }}</span>
    </div>
</div>

<div class="filters">
    <div class="filter-group">
        <label class="filter-label">Minera</label>
        <select id="mineraSelect" onchange="updateFilters()">
            <option value="">Seleccione una minera</option>
            {% for m in mineras %}
            <option value="{{ m }}" {% if minera and m == minera %}selected{% endif %}>
                {{ m }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Transportista</label>
        <select id="transportistaSelect" onchange="updateFilters()">
            <option value="">Seleccione un transportista</option>
            {% for t in transportistas %}
            <option value="{{ t }}" {% if transportista and t == transportista %}selected{% endif %}>
                {{ t }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Fecha</label>
        <input type="date" id="fechaInput" value="{{ fecha if fecha else '' }}" onchange="updateFilters()">
    </div>
</div>

{% if registros %}

<!-- Mini Dashboard de M√©tricas -->
<div style="margin-bottom: 30px;">
 
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
        
        <!-- M√©trica: Disponibilidad Operacional -->
        {% if banda_info and banda_info.disponibilidad_operacional %}
        {% set disp_op = banda_info.disponibilidad_operacional %}
        <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
            <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: #495057;">Disponibilidad Operacional</h3>
            <p style="margin: 0; font-size: 64px; font-weight: bold; line-height: 1; color: {% if disp_op.disponibilidad_porcentaje >= 85 %}#28a745{% else %}#dc3545{% endif %};">
                {{ disp_op.disponibilidad_porcentaje }}%
            </p>
        </div>
        {% endif %}
        
        <!-- M√©trica: Disponibilidad Por Banda -->
        {% set entregados = registros|selectattr('Entregado totalmente', 'equalto', 1)|list|length %}
        
        {% if banda_info and banda_info.get('es_otro_transportista') %}
        <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
            <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: #495057;">Disponibilidad Por Banda</h3>
            <p style="margin: 0; font-size: 64px; font-weight: bold; line-height: 1; color: #6c757d;">
                N/A
            </p>
        </div>
        
        {% elif banda_info and banda_info.banda_total and banda_info.banda_total > 0 %}
        {% set banda_total = banda_info.banda_total %}
        {% set porcentaje = (entregados / banda_total * 100)|round|int %}
        <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
            <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: #495057;">Disponibilidad Por Banda</h3>
            <p style="margin: 0; font-size: 64px; font-weight: bold; line-height: 1; color: {% if porcentaje >= 85 %}#28a745{% else %}#dc3545{% endif %};">
                {{ porcentaje }}%
            </p>
        </div>
        
        {% else %}
        <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
            <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: #495057;">Disponibilidad Por Banda</h3>
            <p style="margin: 0; font-size: 64px; font-weight: bold; line-height: 1; color: #6c757d;">
                N/A
            </p>
        </div>
        {% endif %}
        
        <!-- M√©trica: Disponibilidad Licitada -->
        {% if banda_info and banda_info.disponibilidad_operacional %}
        {% set disp_op = banda_info.disponibilidad_operacional %}
        <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
            <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: #495057;">Disponibilidad Licitada</h3>
            <p style="margin: 0; font-size: 64px; font-weight: bold; line-height: 1; color: {% if disp_op.disponibilidad_licitada_porcentaje >= 85 %}#28a745{% else %}#dc3545{% endif %};">
                {{ disp_op.disponibilidad_licitada_porcentaje }}%
            </p>
        </div>
        {% endif %}
        
    </div>
    
    <!-- F√≥rmulas y Explicaciones -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px;">
        
        <!-- F√≥rmula: Disponibilidad Operacional -->
        {% if banda_info and banda_info.disponibilidad_operacional %}
        {% set disp_op = banda_info.disponibilidad_operacional %}
        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; border-left: 4px solid {% if disp_op.disponibilidad_porcentaje >= 85 %}#28a745{% else %}#dc3545{% endif %};">
            <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: #2c3e50;">üìê F√≥rmula:</div>
            <div style="font-size: 13px; color: #495057; margin-bottom: 12px; font-family: 'Courier New', monospace; background: white; padding: 8px; border-radius: 4px;">
                (Entregas Exitosas / Total Turnos) √ó 100
            </div>
            <div style="font-size: 12px; color: #6c757d; line-height: 1.6;">
                <strong>Entregas Exitosas:</strong> {{ disp_op.entregas_exitosas_total }}<br>
                <small style="padding-left: 10px;">‚Ä¢ Entregadas: {{ disp_op.entregas_criterio_a }}</small><br>
                <small style="padding-left: 10px;">‚Ä¢ Con RCO: {{ disp_op.entregas_criterio_b }}</small><br>
                <strong>Total Turnos:</strong> {{ disp_op.turnos_enviados_total }}
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; font-size: 11px; color: #6c757d;">
                <strong>Criterios:</strong> A) Entregado correctamente | B) No entregado pero con conexi√≥n RCO
            </div>
        </div>
        {% endif %}
        
        <!-- F√≥rmula: Disponibilidad Por Banda -->
        {% if banda_info and banda_info.get('es_otro_transportista') %}
        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; border-left: 4px solid #6c757d;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px; color: #2c3e50;">üìê F√≥rmula:</div>
            <div style="font-size: 16px; color: #495057; margin-bottom: 12px;">
                Sin banda asignada
            </div>
            <div style="font-size: 14px; color: #6c757d; line-height: 1.6;">
                <strong>Entregas Realizadas:</strong> {{ entregados }}
            </div>
            <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid #dee2e6; font-size: 11px; color: #6c757d;">
                <strong>Nota:</strong> OTROS TRANSPORTISTAS - medidos solo por entregas
            </div>
        </div>
        
        {% elif banda_info and banda_info.banda_total and banda_info.banda_total > 0 %}
        {% set banda_total = banda_info.banda_total %}
        {% set porcentaje = (entregados / banda_total * 100)|round|int %}
        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; border-left: 4px solid {% if porcentaje >= 85 %}#28a745{% else %}#dc3545{% endif %};">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px; color: #2c3e50;">üìê F√≥rmula:</div>
            <div style="font-size: 16px; color: #495057; margin-bottom: 12px; font-family: 'Courier New', monospace; background: white; padding: 8px; border-radius: 4px;">
                (Entregas / Banda Total) √ó 100
            </div>
            <div style="font-size: 14px; color: #6c757d; line-height: 1.6;">
                <strong>Entregas:</strong> {{ entregados }}<br>
                <strong>Banda Total:</strong> {{ banda_total }}
            </div>
            <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid #dee2e6; font-size: 11px; color: #6c757d;">
                <strong>M√©todo:</strong> Capacidad asignada por transportista (viajes programados/d√≠a)
            </div>
        </div>
        
        {% else %}
        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; border-left: 4px solid #6c757d;">
            <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: #2c3e50;">üìê F√≥rmula:</div>
            <div style="font-size: 13px; color: #495057; margin-bottom: 12px;">
                Sin informaci√≥n de banda disponible
            </div>
        </div>
        {% endif %}
        
        <!-- F√≥rmula: Disponibilidad Licitada -->
        {% if banda_info and banda_info.disponibilidad_operacional %}
        {% set disp_op = banda_info.disponibilidad_operacional %}
        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; border-left: 4px solid {% if disp_op.disponibilidad_licitada_porcentaje >= 85 %}#28a745{% else %}#dc3545{% endif %};">
            <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: #2c3e50;">üìê F√≥rmula:</div>
            <div style="font-size: 13px; color: #495057; margin-bottom: 12px; font-family: 'Courier New', monospace; background: white; padding: 8px; border-radius: 4px;">
                (Entregas por cami√≥n licitado / Entregas Totales) √ó 100
            </div>
            <div style="font-size: 12px; color: #6c757d; line-height: 1.6;">
                <strong>Entregas por cami√≥n licitado:</strong> {{ disp_op.entregas_licitadas }}<br>
                <strong>Entregas Totales:</strong> {{ disp_op.entregas_totales }}
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; font-size: 11px; color: #6c757d;">
                <strong>Criterio:</strong> Entregas completadas por veh√≠culos de flota licitada vs total de entregas
            </div>
        </div>
        {% endif %}
        
    </div>
</div>

{% if datos_completos %}
<div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 25px;">
    <h2 style="margin-bottom: 20px; color: #2c3e50; font-size: 20px;">üöõ Detalle por Cami√≥n</h2>
    
    <table class="detail-table">
        <thead>
            <tr>
                <th>Cami√≥n</th>
                <th>Fecha</th>
                <th>¬øEs Licitado?</th>
                <th>Transportista</th>
                <th>Turnos Enviados</th>
                <th>Conexi√≥n RCO</th>
                <th>En Ruta</th>
                <th>Planificado</th>
                <th>Entregado Totalmente</th>
            </tr>
        </thead>
        <tbody>
            {% for dato in datos_completos %}
            <tr>
                <td><strong style="color: #3498db;">{{ dato.get('Camion', 'N/A') }}</strong></td>
                <td>{{ dato.get('Fecha', 'N/A') }}</td>
                <td>
                    {% if dato.get('¬øEs licitado?', 'No') == 'Si' %}
                    <span style="color: #28a745; font-weight: bold;">‚úì S√≠</span>
                    {% else %}
                    <span style="color: #6c757d;">‚úó No</span>
                    {% endif %}
                </td>
                <td>{{ dato.get('Transportista', 'N/A') }}</td>
                <td><strong>{{ dato.get('Turnos_enviados', 0) }}</strong></td>
                <td><strong>{{ dato.get('Conexion_RCO', 0) }}</strong></td>
                <td>{{ dato.get('En_ruta', 0) }}</td>
                <td>{{ dato.get('Planificado', 0) }}</td>
                <td>
                    {% set entregado = dato.get('Entregado_totalmente', 0) %}
                    {% if entregado > 0 %}
                    <strong style="color: #28a745;">{{ entregado }}</strong>
                    {% else %}
                    <span style="color: #6c757d;">0</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Tabla de Flota Licitada con Actividad -->
{% if flota_licitada %}
<div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 25px; margin-top: 30px;">
    <h2 style="margin-bottom: 20px; color: #2c3e50; font-size: 20px;">üìã Actividad de Flota Licitada - {{ minera if minera else 'Minera' }}</h2>
    <p style="color: #6c757d; font-size: 14px; margin-bottom: 20px;">
        {% if fecha %}
        Actividad detallada de todos los veh√≠culos licitados para esta minera en la fecha {{ fecha }}.
        {% else %}
        Todos los veh√≠culos licitados para esta minera. Seleccione una fecha para ver la actividad detallada.
        {% endif %}
    </p>
    
    <table class="detail-table">
        <thead>
            <tr>
                <th>C√≥digo Tanque</th>
                <th>Transportista</th>
                <th>Turnos Enviados</th>
                <th>Conexiones RCO</th>
                <th>Entregas Realizadas</th>
                <th>Destinos</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            {% for vehiculo in flota_licitada %}
            <tr style="{% if vehiculo.tiene_actividad %}background-color: #f0f9ff;{% endif %}">
                <td><strong style="color: #3498db;">{{ vehiculo.codigo_tanque }}</strong></td>
                <td style="font-size: 13px;">{{ vehiculo.nombre_transportista }}</td>
                <td style="text-align: center;">
                    {% if vehiculo.turnos_enviados > 0 %}
                    <strong style="color: #17a2b8;">{{ vehiculo.turnos_enviados }}</strong>
                    {% else %}
                    <span style="color: #6c757d;">0</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% if vehiculo.conexiones_rco > 0 %}
                    <strong style="color: #17a2b8;">{{ vehiculo.conexiones_rco }}</strong>
                    {% else %}
                    <span style="color: #6c757d;">0</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% if vehiculo.entregas_realizadas > 0 %}
                    <strong style="color: #28a745;">{{ vehiculo.entregas_realizadas }}</strong>
                    {% else %}
                    <span style="color: #6c757d;">0</span>
                    {% endif %}
                </td>
                <td style="font-size: 12px; max-width: 200px;">
                    {% if vehiculo.destinos %}
                    <details style="cursor: pointer;">
                        <summary style="color: #17a2b8; font-weight: 600;">
                            {{ vehiculo.destinos|length }} destino(s)
                        </summary>
                        <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            {% for entrega in vehiculo.detalle_entregas %}
                            <div style="margin-bottom: 6px; padding: 4px; border-left: 3px solid {% if entrega.estado in ['Entregado totalmente', 'Recib√≠ Conforme'] %}#28a745{% else %}#ffc107{% endif %};">
                                <strong>{{ entrega.destino }}</strong><br>
                                <small style="color: #6c757d;">{{ entrega.estado }}: {{ entrega.cantidad }}</small>
                            </div>
                            {% endfor %}
                        </div>
                    </details>
                    {% else %}
                    <span style="color: #6c757d;">Sin entregas</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% if vehiculo.tiene_actividad %}
                    <span style="color: #28a745; font-weight: bold;">‚úì Activo</span>
                    {% else %}
                    <span style="color: #dc3545; font-weight: bold;">‚úó Sin actividad</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
        <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #17a2b8;">
            <strong style="color: #2c3e50;">Total Veh√≠culos:</strong><br>
            <span style="color: #17a2b8; font-size: 18px; font-weight: bold;">{{ flota_licitada|length }}</span>
        </div>
        <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #28a745;">
            <strong style="color: #2c3e50;">Con Actividad:</strong><br>
            <span style="color: #28a745; font-size: 18px; font-weight: bold;">{{ flota_licitada|selectattr('tiene_actividad')|list|length }}</span>
        </div>
        <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #dc3545;">
            <strong style="color: #2c3e50;">Sin Actividad:</strong><br>
            <span style="color: #dc3545; font-size: 18px; font-weight: bold;">{{ (flota_licitada|length) - (flota_licitada|selectattr('tiene_actividad')|list|length) }}</span>
        </div>
    </div>
</div>
{% endif %}

{% else %}
<div style="text-align: center; padding: 60px; background: #f8f8f8; border-radius: 8px;">
    <p style="font-size: 18px; color: #666;">
        No hay registros disponibles para la selecci√≥n actual.
        <br><br>
        Por favor, seleccione Minera, Transportista y Fecha para ver los datos.
    </p>
</div>
{% endif %}

<div class="button-group" style="margin-top: 30px;">
    <a href="/admin/mineras" class="btn btn-secondary">Gestionar Mineras</a>
</div>

{% endblock %}

{% block extra_js %}
<script>
function updateFilters() {
    const minera = document.getElementById('mineraSelect').value;
    const transportista = document.getElementById('transportistaSelect').value;
    const fecha = document.getElementById('fechaInput').value;
    
    if (minera && transportista && fecha) {
        window.location.href = `/detalle?minera=${encodeURIComponent(minera)}&transportista=${encodeURIComponent(transportista)}&fecha=${fecha}`;
    }
}
</script>
{% endblock %}
