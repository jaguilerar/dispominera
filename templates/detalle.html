{% extends "base.html" %}

{% block content %}
<div class="button-group">
    <a href="/" class="btn btn-secondary">‚Üê Volver al Dashboard</a>
</div>

<div class="info-header">
    <div class="info-item">
        <span class="info-label">Minera:</span>
        <span class="info-value">{{ minera if minera else 'No seleccionada' }}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Transportista:</span>
        <span class="info-value">{{ transportista if transportista else 'No seleccionado' }}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Fecha:</span>
        <span class="info-value">{{ fecha if fecha else 'No seleccionada' }}</span>
    </div>
</div>

<div class="filters">
    <div class="filter-group">
        <label class="filter-label">Minera</label>
        <select id="mineraSelect" onchange="updateFilters()">
            <option value="">Seleccione una minera</option>
            {% for m in mineras %}
            <option value="{{ m }}" {% if minera and m == minera %}selected{% endif %}>
                {{ m }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Transportista</label>
        <select id="transportistaSelect" onchange="updateFilters()">
            <option value="">Seleccione un transportista</option>
            {% for t in transportistas %}
            <option value="{{ t }}" {% if transportista and t == transportista %}selected{% endif %}>
                {{ t }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Fecha</label>
        <input type="date" id="fechaInput" value="{{ fecha if fecha else '' }}" onchange="updateFilters()">
    </div>
</div>

{% if registros %}
<div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 25px;">
    <h2 style="margin-bottom: 20px; color: #333;">Registros de Viajes ({{ registros|length }} viajes)</h2>
    
    <table class="detail-table">
        <thead>
            <tr>
                <th>Pedido</th>
                <th>Cami√≥n</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Transportista</th>
                <th>Cliente</th>
                <th>Entregado</th>
            </tr>
        </thead>
        <tbody>
            {% for registro in registros %}
            <tr>
                <td><strong>{{ registro.get('vbeln', 'N/A') }}</strong></td>
                <td><strong style="color: #3498db;">{{ registro.get('vehiclereal', 'Sin informaci√≥n') }}</strong></td>
                <td>{{ registro.get('vdatu', 'N/A') }}</td>
                <td>{{ registro.get('descrstatu', 'N/A') }}</td>
                <td>{{ registro.get('Transportista', 'N/A') }}</td>
                <td>{{ registro.get('vtext', 'N/A') }}</td>
                <td>
                    {% if registro.get('Entregado totalmente', 0) == 1 %}
                    <span class="check-icon">‚úì</span>
                    {% else %}
                    <span class="cross-icon">‚úó</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if datos_completos %}
<div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 25px; margin-top: 20px;">
    <h2 style="margin-bottom: 20px; color: #333;">Resumen Completo por Cami√≥n ({{ datos_completos|length }} camiones)</h2>
    
    <table class="detail-table">
        <thead>
            <tr>
                <th>Cami√≥n</th>
                <th>Fecha</th>
                <th>¬øEs Licitado?</th>
                <th>Transportista</th>
                <th>Turnos Enviados</th>
                <th>Conexi√≥n RCO</th>
                <th>En Ruta</th>
                <th>Planificado</th>
                <th>Entregado Totalmente</th>
            </tr>
        </thead>
        <tbody>
            {% for dato in datos_completos %}
            <tr>
                <td><strong style="color: #3498db;">{{ dato.get('Camion', 'N/A') }}</strong></td>
                <td>{{ dato.get('Fecha', 'N/A') }}</td>
                <td>
                    {% if dato.get('¬øEs licitado?', 'No') == 'Si' %}
                    <span style="color: #28a745; font-weight: bold;">‚úì S√≠</span>
                    {% else %}
                    <span style="color: #6c757d;">‚úó No</span>
                    {% endif %}
                </td>
                <td>{{ dato.get('Transportista', 'N/A') }}</td>
                <td><strong>{{ dato.get('Turnos_enviados', 0) }}</strong></td>
                <td><strong>{{ dato.get('Conexion_RCO', 0) }}</strong></td>
                <td>{{ dato.get('En_ruta', 0) }}</td>
                <td>{{ dato.get('Planificado', 0) }}</td>
                <td>
                    {% set entregado = dato.get('Entregado_totalmente', 0) %}
                    {% if entregado > 0 %}
                    <strong style="color: #28a745;">{{ entregado }}</strong>
                    {% else %}
                    <span style="color: #6c757d;">0</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div style="margin-top: 20px; padding: 15px; background: #f8f8f8; border-radius: 8px;">
    <h3 style="margin-bottom: 10px; font-size: 16px;">Resumen</h3>
    <div style="display: flex; gap: 30px; flex-wrap: wrap;">
        
        <!-- M√©trica de Disponibilidad Operacional (Nueva L√≥gica) -->
        {% if banda_info and banda_info.disponibilidad_operacional %}
        <div style="margin-top: 15px; padding: 15px; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px;">
            <h4 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 16px;">üìä Disponibilidad Operacional</h4>
            {% set disp_op = banda_info.disponibilidad_operacional %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                <div>
                    <strong>Entregas Exitosas:</strong>
                    <span style="color: #28a745; font-weight: bold; font-size: 18px;">{{ disp_op.entregas_exitosas_total }}</span>
                    <br>
                    <small style="color: #6c757d;">
                        - Criterio A (Entregadas): {{ disp_op.entregas_criterio_a }}<br>
                        - Criterio B (Con RCO): {{ disp_op.entregas_criterio_b }}
                    </small>
                </div>
                <div>
                    <strong>Total Turnos Enviados:</strong>
                    <span style="font-weight: bold; font-size: 18px;">{{ disp_op.turnos_enviados_total }}</span>
                </div>
                <div>
                    <strong>% Disponibilidad:</strong>
                    {% if disp_op.disponibilidad_porcentaje >= 85 %}
                    <span style="color: #28a745; font-weight: bold; font-size: 20px;">{{ disp_op.disponibilidad_porcentaje }}%</span>
                    <span style="color: #28a745;">‚úì Cumple</span>
                    {% else %}
                    <span style="color: #dc3545; font-weight: bold; font-size: 20px;">{{ disp_op.disponibilidad_porcentaje }}%</span>
                    <span style="color: #dc3545;">‚úó No Cumple</span>
                    {% endif %}
                    <br>
                    <small style="color: #6c757d;">
                        F√≥rmula: ({{ disp_op.entregas_exitosas_total }} / {{ disp_op.turnos_enviados_total }}) √ó 100
                    </small>
                </div>
            </div>
            <div style="margin-top: 10px; padding: 8px; background: #fff; border-radius: 4px; font-size: 12px; color: #495057;">
                <strong>‚ÑπÔ∏è Criterios de Entrega Exitosa:</strong><br>
                <strong>A)</strong> Pedido entregado correctamente (Estado: "Entregado totalmente" o "Recib√≠ Conforme")<br>
                <strong>B)</strong> Pedido NO entregado PERO con conexi√≥n RCO registrada (indica intento operacional v√°lido)
            </div>
        </div>
        {% endif %}
        
        <!-- M√©trica Tradicional (Por Banda) -->
        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-left: 4px solid #6c757d; border-radius: 4px;">
            <h4 style="margin: 0 0 10px 0; color: #495057; font-size: 16px;">üìà Disponibilidad Por Banda</h4>
            {% set entregados = registros|selectattr('Entregado totalmente', 'equalto', 1)|list|length %}
            
            {% if banda_info and banda_info.get('es_otro_transportista') %}
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div>
                        <strong>Entregas Realizadas:</strong>
                        <span style="color: #495057; font-weight: bold; font-size: 18px;">{{ entregados }}</span>
                    </div>
                    <div style="padding: 8px 12px; background: #e9ecef; border-radius: 4px;">
                        <small style="color: #6c757d;">Sin banda asignada - OTROS TRANSPORTISTAS</small>
                    </div>
                </div>
            {% elif banda_info and banda_info.banda_total and banda_info.banda_total > 0 %}
                {% set banda_total = banda_info.banda_total %}
                {% set porcentaje = (entregados / banda_total * 100)|round|int %}
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                    <div>
                        <strong>Entregas Realizadas:</strong>
                        <span style="font-weight: bold; font-size: 18px;">{{ entregados }}</span>
                    </div>
                    <div>
                        <strong>Banda Total:</strong>
                        <span style="font-weight: bold; font-size: 18px;">{{ banda_total }}</span>
                    </div>
                    <div>
                        <strong>% Disponibilidad:</strong>
                        {% if porcentaje >= 85 %}
                        <span style="color: #28a745; font-weight: bold; font-size: 20px;">{{ porcentaje }}%</span>
                        <span style="color: #28a745;">‚úì Cumple</span>
                        {% else %}
                        <span style="color: #dc3545; font-weight: bold; font-size: 20px;">{{ porcentaje }}%</span>
                        <span style="color: #dc3545;">‚úó No Cumple</span>
                        {% endif %}
                        <br>
                        <small style="color: #6c757d;">F√≥rmula: ({{ entregados }} / {{ banda_total }}) √ó 100</small>
                    </div>
                </div>
            {% else %}
                <div style="padding: 10px; background: #fff; border-radius: 4px; text-align: center;">
                    <span style="color: #6c757d; font-weight: bold;">N/A - Sin informaci√≥n de banda disponible</span>
                </div>
            {% endif %}
            
            <div style="margin-top: 10px; padding: 8px; background: #fff; border-radius: 4px; font-size: 12px; color: #495057;">
                <strong>‚ÑπÔ∏è M√©todo Tradicional:</strong> Calcula disponibilidad bas√°ndose en la banda de capacidad asignada por transportista (viajes programados por d√≠a).
            </div>
        </div>
    </div>
</div>

{% else %}
<div style="text-align: center; padding: 60px; background: #f8f8f8; border-radius: 8px;">
    <p style="font-size: 18px; color: #666;">
        No hay registros disponibles para la selecci√≥n actual.
        <br><br>
        Por favor, seleccione Minera, Transportista y Fecha para ver los datos.
    </p>
</div>
{% endif %}

<div class="button-group" style="margin-top: 30px;">
    <a href="/admin/mineras" class="btn btn-secondary">Gestionar Mineras</a>
</div>

{% endblock %}

{% block extra_js %}
<script>
function updateFilters() {
    const minera = document.getElementById('mineraSelect').value;
    const transportista = document.getElementById('transportistaSelect').value;
    const fecha = document.getElementById('fechaInput').value;
    
    if (minera && transportista && fecha) {
        window.location.href = `/detalle?minera=${encodeURIComponent(minera)}&transportista=${encodeURIComponent(transportista)}&fecha=${fecha}`;
    }
}
</script>
{% endblock %}
