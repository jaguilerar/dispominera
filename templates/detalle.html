{% extends "base.html" %}

{% block content %}
<div class="button-group">
    <a href="/" class="btn btn-secondary">← Volver al Dashboard</a>
</div>

<div class="info-header">
    <div class="info-item">
        <span class="info-label">Minera:</span>
        <span class="info-value">{{ minera if minera else 'No seleccionada' }}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Transportista:</span>
        <span class="info-value">{{ transportista if transportista else 'No seleccionado' }}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Fecha:</span>
        <span class="info-value">{{ fecha if fecha else 'No seleccionada' }}</span>
    </div>
</div>

<div class="filters">
    <div class="filter-group">
        <label class="filter-label">Minera</label>
        <select id="mineraSelect" onchange="updateFilters()">
            <option value="">Seleccione una minera</option>
            {% for m in mineras %}
            <option value="{{ m }}" {% if minera and m == minera %}selected{% endif %}>
                {{ m }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Transportista</label>
        <select id="transportistaSelect" onchange="updateFilters()">
            <option value="">Seleccione un transportista</option>
            {% for t in transportistas %}
            <option value="{{ t }}" {% if transportista and t == transportista %}selected{% endif %}>
                {{ t }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Fecha</label>
        <input type="date" id="fechaInput" value="{{ fecha if fecha else '' }}" onchange="updateFilters()">
    </div>
</div>

{% if registros %}
<div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 25px;">
    <h2 style="margin-bottom: 20px; color: #333;">Registros de Viajes ({{ registros|length }} viajes)</h2>
    
    <table class="detail-table">
        <thead>
            <tr>
                <th>Pedido</th>
                <th>Camión</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Transportista</th>
                <th>Cliente</th>
                <th>Entregado</th>
            </tr>
        </thead>
        <tbody>
            {% for registro in registros %}
            <tr>
                <td><strong>{{ registro.get('vbeln', 'N/A') }}</strong></td>
                <td><strong style="color: #3498db;">{{ registro.get('vehiclereal', 'Sin información') }}</strong></td>
                <td>{{ registro.get('vdatu', 'N/A') }}</td>
                <td>{{ registro.get('descrstatu', 'N/A') }}</td>
                <td>{{ registro.get('Transportista', 'N/A') }}</td>
                <td>{{ registro.get('vtext', 'N/A') }}</td>
                <td>
                    {% if registro.get('Entregado totalmente', 0) == 1 %}
                    <span class="check-icon">✓</span>
                    {% else %}
                    <span class="cross-icon">✗</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if datos_completos %}
<div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 25px; margin-top: 20px;">
    <h2 style="margin-bottom: 20px; color: #333;">Resumen Completo por Camión ({{ datos_completos|length }} camiones)</h2>
    
    <table class="detail-table">
        <thead>
            <tr>
                <th>Camión</th>
                <th>Fecha</th>
                <th>¿Es Licitado?</th>
                <th>Transportista</th>
                <th>Turnos Enviados</th>
                <th>Conexión RCO</th>
                <th>En Ruta</th>
                <th>Planificado</th>
                <th>Entregado Totalmente</th>
            </tr>
        </thead>
        <tbody>
            {% for dato in datos_completos %}
            <tr>
                <td><strong style="color: #3498db;">{{ dato.get('Camion', 'N/A') }}</strong></td>
                <td>{{ dato.get('Fecha', 'N/A') }}</td>
                <td>
                    {% if dato.get('¿Es licitado?', 'No') == 'Si' %}
                    <span style="color: #28a745; font-weight: bold;">✓ Sí</span>
                    {% else %}
                    <span style="color: #6c757d;">✗ No</span>
                    {% endif %}
                </td>
                <td>{{ dato.get('Transportista', 'N/A') }}</td>
                <td><strong>{{ dato.get('Turnos_enviados', 0) }}</strong></td>
                <td><strong>{{ dato.get('Conexion_RCO', 0) }}</strong></td>
                <td>{{ dato.get('En_ruta', 0) }}</td>
                <td>{{ dato.get('Planificado', 0) }}</td>
                <td>
                    {% set entregado = dato.get('Entregado_totalmente', 0) %}
                    {% if entregado > 0 %}
                    <strong style="color: #28a745;">{{ entregado }}</strong>
                    {% else %}
                    <span style="color: #6c757d;">0</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div style="margin-top: 20px; padding: 15px; background: #f8f8f8; border-radius: 8px;">
    <h3 style="margin-bottom: 10px; font-size: 16px;">Resumen</h3>
    <div style="display: flex; gap: 30px; flex-wrap: wrap;">
        <div>
            <strong>Total de viajes:</strong> {{ registros|length }}
        </div>
        <div>
            <strong>Viajes entregados:</strong> 
            {{ registros|selectattr('Entregado totalmente', 'equalto', 1)|list|length }}
        </div>
        <div>
            <strong>Viajes pendientes:</strong> 
            {{ registros|selectattr('Entregado totalmente', 'equalto', 0)|list|length }}
        </div>
        {% if datos_completos %}
        <div>
            <strong>Total turnos enviados:</strong> 
            {{ datos_completos|sum(attribute='Turnos_enviados') }}
        </div>
        <div>
            <strong>Total conexiones RCO:</strong> 
            {{ datos_completos|sum(attribute='Conexion_RCO') }}
        </div>
        <div>
            <strong>Camiones licitados:</strong> 
            {{ datos_completos|selectattr('¿Es licitado?', 'equalto', 'Si')|list|length }}
        </div>
        {% endif %}
        <div>
            <strong>% Disponibilidad ( N° Turnos realizados / N° Turnos programados ) :</strong> 
            {% set entregados = registros|selectattr('Entregado totalmente', 'equalto', 1)|list|length %}
            {% if banda_info and banda_info.banda_total > 0 %}
                {% set banda_total = banda_info.banda_total %}
                {% set porcentaje = (entregados / banda_total * 100)|round|int %}
                {% if porcentaje >= 85 %}
                <span style="color: #28a745; font-weight: bold;">{{ porcentaje }}% ({{ entregados }}/{{ banda_total }})</span>
                {% else %}
                <span style="color: #dc3545; font-weight: bold;">{{ porcentaje }}% ({{ entregados }}/{{ banda_total }})</span>
                {% endif %}
            {% else %}
                <span style="color: #6c757d; font-weight: bold;">N/A (Sin información de banda)</span>
            {% endif %}
        </div>
    </div>
</div>

{% else %}
<div style="text-align: center; padding: 60px; background: #f8f8f8; border-radius: 8px;">
    <p style="font-size: 18px; color: #666;">
        No hay registros disponibles para la selección actual.
        <br><br>
        Por favor, seleccione Minera, Transportista y Fecha para ver los datos.
    </p>
</div>
{% endif %}

<div class="button-group" style="margin-top: 30px;">
    <a href="/admin/mineras" class="btn btn-secondary">Gestionar Mineras</a>
</div>

{% endblock %}

{% block extra_js %}
<script>
function updateFilters() {
    const minera = document.getElementById('mineraSelect').value;
    const transportista = document.getElementById('transportistaSelect').value;
    const fecha = document.getElementById('fechaInput').value;
    
    if (minera && transportista && fecha) {
        window.location.href = `/detalle?minera=${encodeURIComponent(minera)}&transportista=${encodeURIComponent(transportista)}&fecha=${fecha}`;
    }
}
</script>
{% endblock %}
