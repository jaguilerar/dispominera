{% extends "base.html" %}

{% block content %}

<div class="filters">
    <div class="filter-group">
        <label class="filter-label">Minera</label>
        <select id="mineraSelect">
            <option value="">Seleccione una minera</option>
            {% for minera in mineras %}
            <option value="{{ minera }}">{{ minera }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Año</label>
        <select id="añoSelect">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026" selected>2026</option>
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Mes</label>
        <select id="mesSelect">
            <option value="">Seleccione un mes</option>
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Semana</label>
        <select id="semanaSelect">
            <option value="">Seleccione una semana</option>
        </select>
    </div>
</div>

<div style="text-align: center; margin: 20px 0;">
    <button id="applyFiltersBtn" class="btn btn-primary" onclick="loadDashboardData()">Aplicar Filtros</button>
</div>

<div class="chart-container">
    <h2 class="chart-title">Entregas por día y transportista </h2>
    <canvas id="barChart"></canvas>
</div>

<div class="compliance-matrix" id="matrixContainer">
    <div class="loading">Seleccione los filtros y presione "Aplicar Filtros" para ver los datos</div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let barChart = null;

// Funciones para manejar loading
function showLoading(message = 'Cargando datos...', details = '') {
    const container = document.getElementById('matrixContainer');
    container.innerHTML = `
        <div class="loading-container">
            <div class="spinner"></div>
            <div class="loading-text">${message}</div>
            ${details ? `<div class="loading-details">${details}</div>` : ''}
        </div>
    `;
}

function hideLoading() {
    // El loading se oculta automáticamente cuando se actualiza el contenido
}

// Inicializar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Establecer fecha actual
    const hoy = new Date();
    const mesActual = hoy.getMonth() + 1; // getMonth() retorna 0-11, necesitamos 1-12
    const añoActual = hoy.getFullYear();
    
    // Establecer año actual
    document.getElementById('añoSelect').value = añoActual;
    
    // Establecer mes actual
    document.getElementById('mesSelect').value = mesActual;
    
    // Event listeners para los filtros
    document.getElementById('mineraSelect').addEventListener('change', onMineraChange);
    document.getElementById('añoSelect').addEventListener('change', onAñoChange);
    document.getElementById('mesSelect').addEventListener('change', onMesChange);
    document.getElementById('semanaSelect').addEventListener('change', onSemanaChange);
    
    // Cargar semanas del mes actual y establecer semana actual
    loadSemanas(mesActual, añoActual, true); // El tercer parámetro indica que debe seleccionar la semana actual
});

function onMineraChange() {
    // Solo limpiar la matriz cuando cambie la minera
    document.getElementById('matrixContainer').innerHTML = 
        '<div class="loading">Seleccione los filtros y presione "Aplicar Filtros" para ver los datos</div>';
}

function onAñoChange() {
    const mes = document.getElementById('mesSelect').value;
    const año = document.getElementById('añoSelect').value;
    if (mes && año) {
        loadSemanas(parseInt(mes), parseInt(año), false); // No seleccionar automáticamente al cambiar año
    }
}

function onMesChange() {
    const mes = document.getElementById('mesSelect').value;
    const año = document.getElementById('añoSelect').value;
    if (mes && año) {
        loadSemanas(parseInt(mes), parseInt(año), false); // No seleccionar automáticamente al cambiar mes
    }
}

function onSemanaChange() {
    // Solo actualizar el mensaje cuando cambie la semana
    const minera = document.getElementById('mineraSelect').value;
    const año = document.getElementById('añoSelect').value;
    const mes = document.getElementById('mesSelect').value;
    const semana = document.getElementById('semanaSelect').value;
    
    if (minera && año && mes && semana) {
        document.getElementById('matrixContainer').innerHTML = 
            '<div class="loading">Presione "Aplicar Filtros" para cargar los datos</div>';
    }
}

async function loadSemanas(mes, año, seleccionarActual = false) {
    try {
        // Mostrar loading en el select de semanas
        const semanaSelect = document.getElementById('semanaSelect');
        semanaSelect.innerHTML = '<option value="">Cargando semanas...</option>';
        semanaSelect.disabled = true;

        const response = await fetch(`/api/semanas/${mes}?año=${año}`);
        const data = await response.json();
        
        semanaSelect.innerHTML = '<option value="">Seleccione una semana</option>';
        
        let semanaActual = 1; // Por defecto la primera semana
        
        // Si se solicita seleccionar la semana actual, calcularla
        if (seleccionarActual) {
            const hoy = new Date();
            const primerDiaDelMes = new Date(año, mes - 1, 1); // mes-1 porque Date usa 0-11
            const diaActual = hoy.getDate();
            
            // Verificar si estamos en el mes actual
            if (hoy.getMonth() + 1 === mes && hoy.getFullYear() === año) {
                // Calcular en qué semana del mes estamos
                semanaActual = Math.ceil(diaActual / 7);
                
                // Verificar que la semana calculada esté dentro del rango disponible
                if (semanaActual > data.semanas.length) {
                    semanaActual = data.semanas.length;
                }
            }
        }
        
        data.semanas.forEach(semana => {
            const option = document.createElement('option');
            option.value = semana;
            option.textContent = `Semana ${semana}`;
            if (semana === semanaActual) option.selected = true;
            semanaSelect.appendChild(option);
        });
        
        semanaSelect.disabled = false;
        
    } catch (error) {
        console.error('Error cargando semanas:', error);
        const semanaSelect = document.getElementById('semanaSelect');
        semanaSelect.innerHTML = '<option value="">Error al cargar semanas</option>';
        semanaSelect.disabled = false;
    }
}

async function loadDashboardData() {
    const minera = document.getElementById('mineraSelect').value;
    const año = document.getElementById('añoSelect').value;
    const mes = document.getElementById('mesSelect').value;
    const semana = document.getElementById('semanaSelect').value;
    
    if (!minera || !año || !mes || !semana) {
        document.getElementById('matrixContainer').innerHTML = 
            '<div class="loading">Seleccione Minera, Año, Mes y Semana, luego presione "Aplicar Filtros"</div>';
        return;
    }
    
    // Mostrar loading con detalles específicos
    showLoading(
        'Consultando base de datos...', 
        `Obteniendo datos de ${minera} para ${getMesNombre(mes)} ${año}, Semana ${semana}`
    );
    
    try {
        const response = await fetch(`/api/dashboard_data?minera=${encodeURIComponent(minera)}&año=${año}&mes=${mes}&semana=${semana}`);
        
        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        showLoading('Procesando datos...', 'Generando gráficos y matrices');
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Actualizar gráfico
        updateChart(data.grafico);
        
        // Actualizar matriz
        updateMatrix(data.matriz, minera);
        
    } catch (error) {
        console.error('Error cargando datos:', error);
        document.getElementById('matrixContainer').innerHTML = `
            <div class="loading-container">
                <div style="color: #D90000; font-size: 24px; margin-bottom: 15px;">⚠️</div>
                <div class="loading-text" style="color: #D90000;">Error al cargar los datos</div>
                <div class="loading-details">${error.message}</div>
                <div class="loading-details" style="margin-top: 15px;">
                    Por favor, verifique su conexión e intente nuevamente
                </div>
            </div>
        `;
    }
}

// Función auxiliar para obtener el nombre del mes
function getMesNombre(mes) {
    const meses = [
        '', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
    ];
    return meses[parseInt(mes)] || 'Mes';
}

function updateChart(graficoData) {
    const ctx = document.getElementById('barChart').getContext('2d');
    
    // Destruir gráfico anterior si existe
    if (barChart) {
        barChart.destroy();
    }
    
    // Verificar si hay datos
    if (!graficoData.datos || graficoData.datos.length === 0) {
        // Crear gráfico vacío con mensaje
        barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Sin datos'],
                datasets: [{
                    label: 'No hay datos disponibles',
                    data: [0],
                    backgroundColor: ['#f0f0f0'],
                    borderColor: ['#d0d0d0'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    title: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
        return;
    }
    
    // Generar colores para transportistas
    const transportistas = graficoData.transportistas || [];
    const colores = generateColors(transportistas.length);
    
    const labels = graficoData.datos.map(d => d.fecha);
    
    // Crear datasets para cada transportista
    const datasets = transportistas.map((transportista, index) => ({
        label: transportista,
        data: graficoData.datos.map(d => d[transportista] || 0),
        backgroundColor: colores[index],
        borderColor: colores[index],
        borderWidth: 1
    }));
    
    // Guardar referencia a los datos originales y configuración de bandas del transportista
    window.graficoDataGlobal = graficoData;
    window.bandasTransportista = {}; // Almacenar bandas por transportista
    
    barChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Fecha',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Número de Entregas',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        stepSize: 2
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'right',
                    labels: {
                        boxWidth: 20,
                        padding: 10,
                        font: {
                            size: 12
                        }
                    },
                    onClick: function(e, legendItem, legend) {
                        // Comportamiento por defecto de Chart.js para mostrar/ocultar datasets
                        const index = legendItem.datasetIndex;
                        const ci = legend.chart;
                        const meta = ci.getDatasetMeta(index);
                        
                        // Toggle visibility
                        meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
                        
                        // Recalcular bandas basadas en transportistas visibles
                        recalcularBandas(ci);
                        
                        ci.update();
                    }
                },
                title: {
                    display: false
                },
                annotation: {
                    annotations: {
                        lineMin: {
                            type: 'line',
                            yMin: graficoData.minimo,
                            yMax: graficoData.minimo,
                            borderColor: '#f39c12',
                            borderWidth: 2,
                            borderDash: [6, 3],
                            label: {
                                content: `Mínimo (${graficoData.minimo})`,
                                enabled: true,
                                position: 'end',
                                backgroundColor: 'rgba(243, 156, 18, 0.9)',
                                color: 'white',
                                font: {
                                    weight: 'bold',
                                    size: 11
                                }
                            }
                        },
                        lineMax: {
                            type: 'line',
                            yMin: graficoData.maximo,
                            yMax: graficoData.maximo,
                            borderColor: '#e74c3c',
                            borderWidth: 2,
                            borderDash: [6, 3],
                            label: {
                                content: `Máximo (${graficoData.maximo})`,
                                enabled: true,
                                position: 'end',
                                backgroundColor: 'rgba(231, 76, 60, 0.9)',
                                color: 'white',
                                font: {
                                    weight: 'bold',
                                    size: 11
                                }
                            }
                        }
                    }
                }
            }
        }
    });
}

// Función para generar colores distintivos para transportistas (paleta corporativa)
function generateColors(count) {
    const corporateColors = [
        '#3498db', '#2980b9', '#34495e', '#2c3e50', '#95a5a6',
        '#7f8c8d', '#e74c3c', '#c0392b', '#e67e22', '#d35400',
        '#f39c12', '#f1c40f', '#27ae60', '#229954', '#16a085',
        '#138d75', '#8e44ad', '#7d3c98', '#2980b9', '#5dade2',
        '#48c9b0', '#52be80', '#f7dc6f', '#f8c471', '#ec7063',
        '#af7ac5', '#85c1e9', '#7fb3d3', '#76d7c4', '#82e0aa',
        '#f9e79f', '#f5b7b1', '#d7bde2', '#a9cce3', '#a2d9ce',
        '#abebc6', '#fdeaa7', '#fadbd8', '#e8daef', '#d6eaf8',
        '#d5f3e8', '#d6f3d6', '#fef5d3', '#fdedec', '#f4ecf7',
        '#ebf3fd', '#e8f6f3', '#e8f8f5', '#fef9e7', '#fdf2e9'
    ];
    
    if (count <= corporateColors.length) {
        return corporateColors.slice(0, count);
    }
    
    // Si necesitamos más colores, generamos algunos adicionales en tonos corporativos
    const extraColors = [];
    for (let i = corporateColors.length; i < count; i++) {
        const hue = (i * 137.508) % 360;
        extraColors.push(`hsl(${hue}, 45%, 55%)`); // Saturación y luminosidad corporativa
    }
    
    return [...corporateColors, ...extraColors];
}

// Función para recalcular bandas según transportistas visibles
function recalcularBandas(chart) {
    if (!window.graficoDataGlobal || !window.graficoDataGlobal.bandas_transportista) {
        return; // No hay información de bandas por transportista
    }
    
    // Obtener datasets visibles
    const datasetsVisibles = chart.data.datasets.filter((dataset, index) => {
        const meta = chart.getDatasetMeta(index);
        return !meta.hidden;
    });
    
    if (datasetsVisibles.length === 0) {
        return; // No hay datasets visibles
    }
    
    // Calcular banda total de los transportistas visibles
    let bandaTotal = 0;
    datasetsVisibles.forEach(dataset => {
        const transportista = dataset.label;
        const banda = window.graficoDataGlobal.bandas_transportista[transportista];
        if (banda && banda > 0) {
            bandaTotal += banda;
        }
    });
    
    // Si no hay bandas definidas o son todas null/undefined, usar bandas originales
    if (bandaTotal === 0) {
        bandaTotal = window.graficoDataGlobal.maximo;
    }
    
    // Actualizar anotaciones de líneas
    const annotations = chart.options.plugins.annotation.annotations;
    
    // Actualizar línea mínima (puede ser proporcional o mantener original)
    // Por simplicidad, mantenemos la lógica de banda total
    const bandaMinima = Math.floor(bandaTotal * 0.9); // 90% de la banda total como mínimo
    const bandaMaxima = bandaTotal;
    
    annotations.lineMin.yMin = bandaMinima;
    annotations.lineMin.yMax = bandaMinima;
    annotations.lineMin.label.content = `Mínimo (${bandaMinima})`;
    
    annotations.lineMax.yMin = bandaMaxima;
    annotations.lineMax.yMax = bandaMaxima;
    annotations.lineMax.label.content = `Máximo (${bandaMaxima})`;
}

function updateMatrix(matrizData, minera) {
    const container = document.getElementById('matrixContainer');
    
    if (!matrizData.transportistas || matrizData.transportistas.length === 0) {
        container.innerHTML = '<div class="loading">No hay datos disponibles para esta selección</div>';
        return;
    }
    
    let html = '<table class="matrix-table"><thead><tr>';
    html += '<th>Transportista</th>';
    
    matrizData.fechas.forEach(fecha => {
        html += `<th>${fecha}</th>`;
    });
    
    html += '</tr></thead><tbody>';
    
    matrizData.transportistas.forEach(transportista => {
        html += '<tr>';
        html += `<td class="transportista-cell">${transportista}</td>`;
        
        matrizData.fechas.forEach(fecha => {
            const celda = matrizData.datos[transportista][fecha];

            // Verificar si es "OTRO TRANSPORTISTA"
            if (transportista === 'OTRO TRANSPORTISTA' || celda.es_otro) {
                // Para "OTRO TRANSPORTISTA", mostrar solo las entregas sin color ni porcentaje
                html += `<td>
                    <div class="percentage-circle neutral" 
                         onclick="goToDetail('${minera}', '${transportista}', '${celda.fecha_full}')"
                         title="Entregas realizadas: ${celda.total}">
                        ${celda.total}
                        <div class="tooltip-content">
                            <div class="tooltip-metrics">
                                <div class="tooltip-metric">
                                    <div class="tooltip-metric-label">Disp. Operacional</div>
                                    <div class="tooltip-metric-value" style="color: #6c757d;">N/A</div>
                                    <div class="tooltip-metric-formula">Sin turnos</div>
                                </div>
                                <div class="tooltip-metric">
                                    <div class="tooltip-metric-label">Disp. Por Banda</div>
                                    <div class="tooltip-metric-value" style="color: #6c757d;">N/A</div>
                                    <div class="tooltip-metric-formula">Sin banda</div>
                                </div>
                                <div class="tooltip-metric">
                                    <div class="tooltip-metric-label">Disp. Licitada</div>
                                    <div class="tooltip-metric-value" style="color: #6c757d;">N/A</div>
                                    <div class="tooltip-metric-formula">Sin datos</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>`;
            } else {
                // Para transportistas autorizados, mostrar porcentaje con colores
                const colorClass = celda.porcentaje >= 80 ? 'green' : 'red';
                
                // Disponibilidad Operacional es el porcentaje principal de la celda
                const dispOperacional = celda.porcentaje || 0;
                
                // Disponibilidad por Banda (solo entregas/banda sin criterio B)
                const dispBanda = celda.disponibilidad_banda || 0;
                
                // Entregas por Flota Licitada
                const entregasLicitadas = celda.entregas_licitadas || 0;
                const entregasTotales = celda.entregas_totales || 0;
                const dispLicitadaPct = entregasTotales > 0 ? Math.round((entregasLicitadas / entregasTotales) * 100) : 0;
                
                const colorDispOp = dispOperacional >= 80 ? '#28a745' : '#dc3545';
                const colorDispBanda = dispBanda >= 80 ? '#28a745' : '#dc3545';
                const colorDispLic = dispLicitadaPct >= 80 ? '#28a745' : '#dc3545';
                
                html += `<td>
                    <div class="percentage-circle ${colorClass}" 
                         onclick="goToDetail('${minera}', '${transportista}', '${celda.fecha_full}')">
                        ${dispOperacional.toFixed(1)}%
                        <div class="tooltip-content">
                            <div class="tooltip-metrics">
                                <div class="tooltip-metric">
                                    <div class="tooltip-metric-label">Disp. Operacional</div>
                                    <div class="tooltip-metric-value" style="color: ${colorDispOp};">${dispOperacional.toFixed(1)}%</div>
                                </div>
                                <div class="tooltip-metric">
                                    <div class="tooltip-metric-label">Cumpl. Por Banda</div>
                                    <div class="tooltip-metric-value" style="color: ${colorDispBanda};">${dispBanda.toFixed(1)}%</div>
                                </div>
                                <div class="tooltip-metric">
                                    <div class="tooltip-metric-label">Entreg. por Flota Licitada</div>
                                    <div class="tooltip-metric-value" style="color: ${colorDispLic};">${dispLicitadaPct}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>`;
            }
        });
        
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
    
    // Agregar event listeners para posicionar tooltips dinámicamente
    setTimeout(() => {
        const circles = document.querySelectorAll('.percentage-circle');
        circles.forEach(circle => {
            circle.addEventListener('mouseenter', function(e) {
                const tooltip = this.querySelector('.tooltip-content');
                if (tooltip) {
                    const rect = this.getBoundingClientRect();
                    const tooltipHeight = 200; // Altura aproximada del tooltip
                    const spaceAbove = rect.top;
                    const spaceBelow = window.innerHeight - rect.bottom;
                    
                    // Si no hay suficiente espacio arriba (menos de 220px), mostrar abajo
                    if (spaceAbove < 220 && spaceBelow > tooltipHeight) {
                        tooltip.classList.add('tooltip-below');
                    } else {
                        tooltip.classList.remove('tooltip-below');
                    }
                }
            });
        });
    }, 100);
}

function goToDetail(minera, transportista, fecha) {
    window.location.href = `/detalle?minera=${encodeURIComponent(minera)}&transportista=${encodeURIComponent(transportista)}&fecha=${fecha}`;
}
</script>
{% endblock %}
